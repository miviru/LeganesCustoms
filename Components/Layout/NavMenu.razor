@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavigationManager
@inject ILocalStorageService LocalStorage
@using Blazored.LocalStorage

<nav class="navbar navbar-expand-lg bg-dark navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">
            <img src="/Logo4.png" style="height: 100px;" alt="Logo" />
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <NavLink class="nav-link" href="/performance" Match="NavLinkMatch.Prefix">Performance</NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link" href="/servicios" Match="NavLinkMatch.Prefix">Servicios</NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link" href="/pedircita" Match="NavLinkMatch.Prefix">Pedir Cita</NavLink>
                </li>
                @if (isAuthenticated)
                {
                    @if (isAdmin)
                    {
                        <li class="nav-item">
                            <NavLink class="nav-link" href="/admin">Admin</NavLink>
                        </li>
                    }
                    else if (isMechanic)
                    {
                        <li class="nav-item">
                            <NavLink class="nav-link" href="/mecanico">@userName</NavLink>
                        </li>
                    }
                    else if (isReceptionist)
                    {
                        <li class="nav-item">
                            <NavLink class="nav-link" href="/recepcionista">@userName</NavLink>
                        </li>
                    }
                    else if (isClient)
                    {
                        <li class="nav-item">
                            <NavLink class="nav-link" href="/clientesIndex">@userName</NavLink>
                        </li>
                    }
                    <li class="nav-item">
                        <button class="btn nav-link" @onclick="LogOut">Cerrar sesión</button>
                    </li>
                }
                else
                {
                    <li class="nav-item">
                        <NavLink class="nav-link" href="/Identity/Account/Login">Iniciar Sesión</NavLink>
                    </li>
                }
            </ul>
        </div>
    </div>
</nav>

@code {
    private bool isAuthenticated = false;
    private bool isAdmin = false;
    private bool isMechanic = false;
    private bool isReceptionist = false;
    private bool isClient = false;
    private string userName = string.Empty;

    protected override async Task OnInitializedAsync()
{
    try
    {
        var client = HttpClientFactory.CreateClient("DefaultClient");
        var response = await client.GetAsync("api/auth/userinfo");

        if (response.IsSuccessStatusCode)
        {
            var userInfo = await response.Content.ReadFromJsonAsync<UserInfo>();

            if (userInfo != null)
            {
                isAuthenticated = userInfo.IsAuthenticated;
                isAdmin = userInfo.Roles.Contains("Admin");
                userName = userInfo.Name;

                StateHasChanged();
            }
        }
        else
        {
            isAuthenticated = false; // Asegurar el estado cuando la solicitud falla
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Error al procesar la solicitud: {ex.Message}");
        isAuthenticated = false; // Asegurar el estado en caso de excepción
    }
}

    private class UserInfo
    {
        public bool IsAuthenticated { get; set; }
        public List<string> Roles { get; set; } = new List<string>();
        public string Name { get; set; } = string.Empty;
    }

    // Método que limpia el estado de autenticación
    private void ResetAuthenticationState()
    {
        isAuthenticated = false;
        isAdmin = false;
        isMechanic = false;
        isReceptionist = false;
        isClient = false;
        userName = string.Empty;

        StateHasChanged(); // Forzar actualización de la UI
    }

    private async Task LogOut()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("DefaultClient");
            var response = await client.PostAsync("api/auth/logout", null);

            if (response.IsSuccessStatusCode)
            {
                ResetAuthenticationState();
                userName = string.Empty;
                // Limpia estado local
                await LocalStorage.ClearAsync();
                NavigationManager.NavigateTo("/", true);
            }
            else
            {
                Console.WriteLine($"Error al cerrar sesión: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cerrar sesión: {ex.Message}");
        }
    }

}
